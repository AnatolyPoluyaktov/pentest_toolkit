import json
import os
from datetime import datetime

import markdown
from django.contrib import messages
from django.db.models import Count
from django.http import HttpResponse, HttpResponseRedirect, JsonResponse
from django.shortcuts import get_object_or_404, render
from django.template.loader import get_template
from django.urls import reverse
from django.utils import timezone
from django_celery_beat.models import (ClockedSchedule, IntervalSchedule,
                                       PeriodicTask)
from weasyprint import HTML

from core.celery import app
from core.common_func import *
from core.scanEngine.models import EngineType, VulnerabilityReportSetting
from core.startScan.models import *
from core.targetApp.models import Domain, project
from core.tasks import create_scan_activity, initiate_scan


def delete_scans(request):
    context = {}
    if request.method == "POST":
        list_of_scan_id = []

        for key, value in request.POST.items():
            if key != "scan_history_table_length" and key != "csrfmiddlewaretoken":
                obj = get_object_or_404(ScanHistory, id=value)
                delete_dir = obj.results_dir
                os.system("rm -rf /usr/src/scan_results/" + delete_dir)
                obj.delete()
        messages.add_message(request, messages.INFO, "All Scans deleted!")
    return HttpResponseRedirect(reverse("scan_history"))
