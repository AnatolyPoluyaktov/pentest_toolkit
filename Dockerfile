FROM golang:1.18.4-alpine AS builder
RUN apk add build-base libpcap-dev
RUN go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
## Download Go packages
RUN go install -v github.com/hakluke/hakrawler@latest

RUN go install -v -v github.com/bp0lr/gauplus@latest

RUN go install -v github.com/jaeles-project/gospider@latest

RUN go install -v github.com/OWASP/Amass/v3/...@latest

RUN go install -v github.com/ffuf/ffuf@latest

RUN go install -v github.com/tomnomnom/assetfinder@latest
RUN go install -v github.com/tomnomnom/gf@latest
RUN go install -v github.com/tomnomnom/unfurl@latest
RUN go install -v github.com/tomnomnom/waybackurls@latest

RUN go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
RUN go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
RUN go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest



# Update Nuclei and Nuclei-Templates
RUN nuclei -update
RUN nuclei -update-templates

FROM python:3.9.13-bullseye

# Environment Variables
WORKDIR /usr/src/app


ENV PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    PIP_DEFAULT_TIMEOUT=100 \
    POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_CREATE=0 \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/usr/src/app

## Install essentials
RUN apt update -y && apt install -y  --no-install-recommends \
    build-essential \
    cmake \
    firefox-esr-l10n-en-gb \
    gcc \
    git \
    libpq-dev \
    libpq-dev \
    libpcap-dev \
    netcat \
    postgresql \
    python3 \
    python3-dev \
    python3-pip \
    python3-netaddr \
    wget \
    x11-utils \
    xvfb \
    python3-cffi \
    python3-brotli \
    libpango-1.0-0 \
    libpangoft2-1.0-0 \
    geoip-bin \
    geoip-database

COPY poetry.lock pyproject.toml requirements.txt  /usr/src/app/

RUN pip3  install poetry==1.1.10 Pillow setuptools wheel
RUN poetry install --no-ansi

RUN pip install fuzzywuzzy \
    selenium \
    python-Levenshtein \
    pyvirtualdisplay \
    netaddr \
    whatportis

## Copy source code

COPY --from=builder /go/bin/nuclei /usr/local/bin/nuclei
COPY --from=builder /go/bin/naabu /usr/local/bin/naabu
COPY --from=builder /go/bin/hakrawler /usr/local/bin/hakrawler
COPY --from=builder /go/bin/gauplus /usr/local/bin/gauplus
COPY --from=builder /go/bin/gospider /usr/local/bin/gospider
COPY --from=builder /go/bin/ffuf /usr/local/bin/ffuf
COPY --from=builder /go/bin/assetfinder /usr/local/bin/assetfinder
COPY --from=builder /go/bin/gf /usr/local/bin/gf
COPY --from=builder /go/bin/unfurl /usr/local/bin/unfurl
COPY --from=builder /go/bin/waybackurls /usr/local/bin/waybackurls
COPY --from=builder /go/bin/httpx /usr/local/bin/httpx
COPY --from=builder /go/bin/subfinder /usr/local/bin/subfinder

COPY . .

RUN echo 'alias httpx="/go/bin/httpx"' >> ~/.bashrc
